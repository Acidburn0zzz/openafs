.rn '' }`
''' $RCSfile$$Revision$$Date$
'''
''' $Log$
'''
.de Sh
.br
.if t .Sp
.ne 5
.PP
\fB\\$1\fR
.PP
..
.de Sp
.if t .sp .5v
.if n .sp
..
.de Ip
.br
.ie \\n(.$>=3 .ne \\$3
.el .ne 3
.IP "\\$1" \\$2
..
.de Vb
.ft CW
.nf
.ne \\$1
..
.de Ve
.ft R

.fi
..
'''
'''
'''     Set up \*(-- to give an unbreakable dash;
'''     string Tr holds user defined translation string.
'''     Bell System Logo is used as a dummy character.
'''
.tr \(*W-|\(bv\*(Tr
.ie n \{\
.ds -- \(*W-
.ds PI pi
.if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\" diablo 12 pitch
.ds L" ""
.ds R" ""
'''   \*(M", \*(S", \*(N" and \*(T" are the equivalent of
'''   \*(L" and \*(R", except that they are used on ".xx" lines,
'''   such as .IP and .SH, which do another additional levels of
'''   double-quote interpretation
.ds M" """
.ds S" """
.ds N" """""
.ds T" """""
.ds L' '
.ds R' '
.ds M' '
.ds S' '
.ds N' '
.ds T' '
'br\}
.el\{\
.ds -- \(em\|
.tr \*(Tr
.ds L" ``
.ds R" ''
.ds M" ``
.ds S" ''
.ds N" ``
.ds T" ''
.ds L' `
.ds R' '
.ds M' `
.ds S' '
.ds N' `
.ds T' '
.ds PI \(*p
'br\}
.\"	If the F register is turned on, we'll generate
.\"	index entries out stderr for the following things:
.\"		TH	Title 
.\"		SH	Header
.\"		Sh	Subsection 
.\"		Ip	Item
.\"		X<>	Xref  (embedded
.\"	Of course, you have to process the output yourself
.\"	in some meaninful fashion.
.if \nF \{
.de IX
.tm Index:\\$1\t\\n%\t"\\$2"
..
.nr % 0
.rr F
.\}
.TH salvageserver 8 "OpenAFS" "14/Mar/2008" "AFS Command Reference"
.UC
.if n .hy 0
.if n .na
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.de CQ          \" put $1 in typewriter font
.ft CW
'if n "\c
'if t \\&\\$1\c
'if n \\&\\$1\c
'if n \&"
\\&\\$2 \\$3 \\$4 \\$5 \\$6 \\$7
'.ft R
..
.\" @(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2
.	\" AM - accent mark definitions
.bd B 3
.	\" fudge factors for nroff and troff
.if n \{\
.	ds #H 0
.	ds #V .8m
.	ds #F .3m
.	ds #[ \f1
.	ds #] \fP
.\}
.if t \{\
.	ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.	ds #V .6m
.	ds #F 0
.	ds #[ \&
.	ds #] \&
.\}
.	\" simple accents for nroff and troff
.if n \{\
.	ds ' \&
.	ds ` \&
.	ds ^ \&
.	ds , \&
.	ds ~ ~
.	ds ? ?
.	ds ! !
.	ds /
.	ds q
.\}
.if t \{\
.	ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.	ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.	ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.	ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.	ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.	ds ? \s-2c\h'-\w'c'u*7/10'\u\h'\*(#H'\zi\d\s+2\h'\w'c'u*8/10'
.	ds ! \s-2\(or\s+2\h'-\w'\(or'u'\v'-.8m'.\v'.8m'
.	ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.	ds q o\h'-\w'o'u*8/10'\s-4\v'.4m'\z\(*i\v'-.4m'\s+4\h'\w'o'u*8/10'
.\}
.	\" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds v \\k:\h'-(\\n(.wu*9/10-\*(#H)'\v'-\*(#V'\*(#[\s-4v\s0\v'\*(#V'\h'|\\n:u'\*(#]
.ds _ \\k:\h'-(\\n(.wu*9/10-\*(#H+(\*(#F*2/3))'\v'-.4m'\z\(hy\v'.4m'\h'|\\n:u'
.ds . \\k:\h'-(\\n(.wu*8/10)'\v'\*(#V*4/10'\z.\v'-\*(#V*4/10'\h'|\\n:u'
.ds 3 \*(#[\v'.2m'\s-2\&3\s0\v'-.2m'\*(#]
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.ds oe o\h'-(\w'o'u*4/10)'e
.ds Oe O\h'-(\w'O'u*4/10)'E
.	\" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.	\" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.	ds : e
.	ds 8 ss
.	ds v \h'-1'\o'\(aa\(ga'
.	ds _ \h'-1'^
.	ds . \h'-1'.
.	ds 3 3
.	ds o a
.	ds d- d\h'-1'\(ga
.	ds D- D\h'-1'\(hy
.	ds th \o'bp'
.	ds Th \o'LP'
.	ds ae ae
.	ds Ae AE
.	ds oe oe
.	ds Oe OE
.\}
.rm #[ #] #H #V #F C
.SH "NAME"
salvageserver \- Initializes the Salvageserver component of the dafs process
.SH "SYNOPSIS"
\fBsalvageserver\fR [\fIinitcmd\fR] <<\ [\fB\-partition\fR\ <\fIname\ of\ partition\ to\ salvage\fR] >>>
    <<\ [\fB\-volumeid\fR\ <\fIvolume\ id\ to\ salvage\fR] >>> [\fB\-debug\fR] [\fB\-nowrite\fR]
    [\fB\-inodes\fR] [\fB\-force\fR] [\fB\-oktozap\fR] [\fB\-rootinodes\fR]
    [\fB\-salvagedirs\fR] [\fB\-blockreads\fR]
    <<\ [\fB\-parallel\fR\ <\fI#\ of\ max\ parallel\ partition\ salvaging\fR] >>>
    <<\ [\fB\-tmpdir\fR\ <\fIname\ of\ dir\ to\ place\ tmp\ files\fR] >>>
    [\fB\-showlog\fR] [\fB\-showsuid\fR] [\fB\-showmounts\fR]
    <<\ [\fB\-orphans\fR\ (ignore\ |\ remove\ |\ attach)]\ >>
    [\fB\-client\fR] [\fB\-help\fR]
.SH "DESCRIPTION"
In its typical mode of operation, the \fBsalvageserver\fR is a daemon process 
responsible for salvaging volumes.  It is a component of the \f(CWdafs\fR 
process type.  In the conventional configuration, its binary file is 
located in the \fI/usr/afs/bin\fR directory on a file server machine.
.PP
The Salvageserver daemon is responsible for scheduling and executing 
volume salvage operations on behalf of client processes.  The fileserver 
acts as the primary salvageserver client: any failed volume attach 
operation results in a salvageserver scheduling request.  The 
salvageserver also accepts periodic volume activity messages in order to 
update its salvage request priority queue.  Other clients of the 
salvageserver daemon include the \fBsalvsync-debug\fR utility, and the
salvageserver command itself by passing the \fB\-client\fR flag.
.PP
The salvage operations performed on vice partition data are nearly 
identical to those performed by the standalone Salvager command.  The 
key differences between the two commands are:
.Ip "\(bu" 4
The Salvageserver is a daemon process which runs concurrently with the 
fileserver.  In contrast, the Salvager is a stand-alone application which 
is invoked when the fileserver and volserver are not running.
.Ip "\(bu" 4
The Salvageserver is incapable of performing whole partition salvage 
operations; it operates at volume group granularity.
.PP
The Salvageserver normally creates new inodes as it repairs damage. If the
partition is so full that there is no room for new inodes, use the
\fB\-nowrite\fR argument to bringing undamaged volumes online without
attempting to salvage damaged volumes. Then use the \fBvos move\fR command to
move one or more of the undamaged volumes to other partitions, freeing up
the space that the Salvageserver needs to create new inodes.
.PP
By default, multiple Salvageserver subprocesses run in parallel: one for each 
volume group.  By default, four concurrent salvage operations are 
permitted.  You may alter this default by providing a positive integer 
value for the \fB\-parallel\fR argument.  The maximum permitted value is 32 
concurrent salvageserver subprocesses.
.PP
By default, the salvageserver enables a heuristic which attempts to stop
disk head thrashing by concurrent salvageserver subprocesses.  Unfortunately,
this heuristic significantly degrades performance in many cases.  In at least 
the following environments, passing the \f(CWall\fR string to the \fB\-parallel\fR 
argument is strongly encouraged:
.Ip "\(bu" 4
On \s-1NAMEI\s0 fileservers
.Ip "\(bu" 4
When a vice partition is backed by multiple disks (e.g. \s-1RAID\s0)
.Ip "\(bu" 4
When a vice partition is backed by \s-1SAN\s0\-attached storage, \s-1LVM\s0, or some other
form of storage virtualization which would cause unix device id numbers to
be unpredictable.
.PP
The Salvageserver creates temporary files as it runs, by default writing them
to the partition it is salvaging. The number of files can be quite large,
and if the partition is too full to accommodate them, the Salvageserver
terminates without completing the salvage operation (it always removes the
temporary files before exiting). Other Salvageserver subprocesses running at
the same time continue until they finish salvaging all other partitions
where there is enough disk space for temporary files. To complete the
interrupted salvage, reissue the command against the appropriate
partitions, adding the \fB\-tmpdir\fR argument to redirect the temporary files
to a local disk directory that has enough space.
.PP
The \fB\-orphans\fR argument controls how the Salvageserver handles orphaned files
and directories that it finds on server partitions it is salvaging. An
\fIorphaned\fR element is completely inaccessible because it is not
referenced by the vnode of any directory that can act as its parent (is
higher in the filespace). Orphaned objects occupy space on the server
partition, but do not count against the volume's quota.
.PP
To generate a list of all mount points that reside in one or more volumes,
rather than actually salvaging them, include the \fB\-showmounts\fR flag.
.PP
This command does not use the syntax conventions of the \s-1AFS\s0 command
suites. Provide the command name and all option names in full.
.SH "OPTIONS"
.Ip "[\fIinitcmd\fR]" 4
Accommodates the command's use of the \s-1AFS\s0 command parser, and is optional.
.Ip "\fB\-partition\fR <\fIname of partition to salvage\fR>" 4
Specifies the name of the partition to salvage. Specify the full partition
name using the form \fI/vicep\fIx\fR\fR or \fI/vicep\fIxx\fR\fR. Omit this argument to
salvage every partition on the file server machine.
.Ip "\fB\-volumeid\fR <\fIvolume id to salvage\fR>" 4
Specifies the volume \s-1ID\s0 of a specific read/write volume to salvage.  The
\fB\-partition\fR argument must be provided along with this one and specify
the volume's actual site.
.Ip "\fB\-debug\fR" 4
This flag should be considered deprecated.  Its primary purpose was to disable
forking and parallelization of the Salvager so that log messages were not
interleaved.  Due to the manner in which \fI/usr/afs/logs/SalSrvLog\fR is 
written, log messages from subprocesses are never interleaved; the entire log
for a volume group salvage is appended to the master log as one atomic 
transaction.
.Ip "\fB\-nowrite\fR" 4
Brings all undamaged volumes online without attempting to salvage any
damaged volumes.
.Ip "\fB\-inodes\fR" 4
Records in the \fI/usr/afs/logs/SalSrvLog\fR file a list of all \s-1AFS\s0 inodes
that the Salvageserver modified.
.Ip "\fB\-force\fR" 4
Inspects all volumes for corruption, not just those that are marked as
having been active when a crash occurred.
.Ip "\fB\-oktozap\fR" 4
Removes a volume that is so damaged that even issuing the \fBvos zap\fR
command with the \fB\-force\fR flag is ineffective. Use this argument only in
consultation with \s-1AFS\s0 Development or Product Support. Combine it with the
\fB\-partition\fR and \fB\-volumeid\fR arguments to identify the volume to remove.
.Ip "\fB\-rootinodes\fR" 4
Records in the \fI/usr/afs/logs/SalSrvLog\fR file a list of all \s-1AFS\s0 inodes
owned by the local superuser \f(CWroot\fR.
.Ip "\fB\-salvagedirs\fR" 4
Salvages entire directory structures, even if they do not appear to be
damaged. By default, the Salvageserver salvages a directory only if it is
flagged as corrupted.
.Ip "\fB\-blockreads\fR" 4
Forces the Salvageserver to read a partition one disk block (512 bytes) at a
time and to skip any blocks that are too badly damaged to be salvaged.
This allows it to salvage as many volumes as possible. By default, the
Salvageserver reads large disk blocks, which can cause it to exit prematurely
if it encounters disk errors. Use this flag if the partition to be
salvaged has disk errors.
.Ip "\fB\-parallel\fR <\fI# of max parallel partition salvaging\fR>" 4
Specifies the maximum number of Salvageserver subprocesses to run in parallel.
Provide one of three values:
.Ip "\(bu" 8
An integer from the range \f(CW1\fR to \f(CW32\fR. A value of \f(CW1\fR means that a
single Salvageserver subprocess salvages the volume groups sequentially.
The disk partition heuristic (see above) based upon unix device ids is 
enabled.
.Ip "\(bu" 8
The disk partition heuristic (see above) based upon unix device ids is 
disabled.
.Ip "\(bu" 8
The string \f(CWall\fR followed immediately (with no intervening space) by an
integer from the range \f(CW1\fR to \f(CW32\fR, to run the specified number of
Salvageserver subprocesses in parallel on volume groups.  The disk partition 
heuristic (see above) based upon unix device ids is disabled.
.Sp
If this argument is omitted, up to four Salvageserver subprocesses run
in parallel.
.Ip "\fB\-tmpdir\fR <\fIname of dir to place tmp files\fR>" 4
Names a local disk directory in which the Salvageserver places the temporary
files it creates during a salvage operation, instead of writing them to
the partition being salvaged (the default). If the Salvageserver cannot write
to the specified directory, it attempts to write to the partition being
salvaged.
.Ip "\fB\-showlog\fR" 4
Displays on the standard output stream all log data that is being written
to the \fI/usr/afs/logs/SalSrvLog\fR file.
.Ip "\fB\-showsuid\fR" 4
Displays a list of the pathnames for all files that have the setuid or
setgid mode bit set.
.Ip "\fB\-showmounts\fR" 4
Records in the \fI/usr/afs/logs/SalSrvLog\fR file all mount points found in
each volume. The Salvageserver does not repair corruption in the volumes, if
any exists.
.Ip "\fB\-orphans\fR (ignore | remove | attach)" 4
Controls how the Salvageserver handles orphaned files and directories.  Choose
one of the following three values:
.Ip "ignore" 8
Leaves the orphaned objects on the disk, but prints a message to the
\fI/usr/afs/logs/SalSrvLog\fR file reporting how many orphans were found and
the approximate number of kilobytes they are consuming. This is the
default if the \fB\-orphans\fR argument is omitted.
.Ip "remove" 8
Removes the orphaned objects, and prints a message to the
\fI/usr/afs/logs/SalSrvLog\fR file reporting how many orphans were removed
and the approximate number of kilobytes they were consuming.
.Ip "attach" 8
Attaches the orphaned objects by creating a reference to them in the vnode
of the volume's root directory. Since each object's actual name is now
lost, the Salvageserver assigns each one a name of the following form:
.Ip "\f(CW__ORPHANFILE__.\fIindex\fR\fR for files." 12
.Ip "\f(CW__ORPHANDIR__.\fIindex\fR\fR for directories." 12
.Sp
where \fIindex\fR is a two-digit number that uniquely identifies each
object. The orphans are charged against the volume's quota and appear in
the output of the \fBls\fR command issued against the volume's root
directory.
.Ip "\fB\-client\fR" 4
Salvageserver runs in client Mode.  The requested volume on the requested
partition will be scheduled for salvaging by the Salvageserver daemon.
.Ip "\fB\-help\fR" 4
Prints the online help for this command. All other valid options are
ignored.
.SH "EXAMPLES"
The following command instructs the Salvageserver to schedule the salvage 
of the volume with volume ID 258347486 on \fI/vicepg\fR on the local machine.
.PP
.Vb 1
\&   % /usr/afs/bin/salvageserver -partition /vicepg -volumeid 258347486 -client
.Ve
.SH "PRIVILEGE REQUIRED"
To issue the command at the shell prompt, the issuer must be logged in as
the local superuser \f(CWroot\fR.
.SH "SEE ALSO"
the \fIBosConfig(5)\fR manpage,
the \fISalvageLog(5)\fR manpage,
the \fISalvager(8)\fR manpage,
the \fIbos_create(8)\fR manpage,
the \fIbos_getlog(8)\fR manpage,
the \fIbos_salvage(8)\fR manpage,
the \fIvos_move(1)\fR manpage
.SH "COPYRIGHT"
IBM Corporation 2000. <http://www.ibm.com/> All Rights Reserved.
Sine Nomine Associates 2008.  All Rights Reserved.
.PP
This documentation is covered by the IBM Public License Version 1.0.  It was
converted from HTML to POD by software written by Chas Williams and Russ
Allbery, based on work by Alf Wachsmann and Elizabeth Cassell.  This document
was adapted from the Salvager POD documentation.

.rn }` ''
.IX Title "salvageserver 8"
.IX Name "salvageserver - Initializes the Salvageserver component of the dafs process"

.IX Header "NAME"

.IX Header "SYNOPSIS"

.IX Header "DESCRIPTION"

.IX Item "\(bu"

.IX Item "\(bu"

.IX Item "\(bu"

.IX Item "\(bu"

.IX Item "\(bu"

.IX Header "OPTIONS"

.IX Item "[\fIinitcmd\fR]"

.IX Item "\fB\-partition\fR <\fIname of partition to salvage\fR>"

.IX Item "\fB\-volumeid\fR <\fIvolume id to salvage\fR>"

.IX Item "\fB\-debug\fR"

.IX Item "\fB\-nowrite\fR"

.IX Item "\fB\-inodes\fR"

.IX Item "\fB\-force\fR"

.IX Item "\fB\-oktozap\fR"

.IX Item "\fB\-rootinodes\fR"

.IX Item "\fB\-salvagedirs\fR"

.IX Item "\fB\-blockreads\fR"

.IX Item "\fB\-parallel\fR <\fI# of max parallel partition salvaging\fR>"

.IX Item "\(bu"

.IX Item "\(bu"

.IX Item "\(bu"

.IX Item "\fB\-tmpdir\fR <\fIname of dir to place tmp files\fR>"

.IX Item "\fB\-showlog\fR"

.IX Item "\fB\-showsuid\fR"

.IX Item "\fB\-showmounts\fR"

.IX Item "\fB\-orphans\fR (ignore | remove | attach)"

.IX Item "ignore"

.IX Item "remove"

.IX Item "attach"

.IX Item "\f(CW__ORPHANFILE__.\fIindex\fR\fR for files."

.IX Item "\f(CW__ORPHANDIR__.\fIindex\fR\fR for directories."

.IX Item "\fB\-client\fR"

.IX Item "\fB\-help\fR"

.IX Header "EXAMPLES"

.IX Header "PRIVILEGE REQUIRED"

.IX Header "SEE ALSO"

.IX Header "COPYRIGHT"

